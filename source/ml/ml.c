#include <stdlib.h>
#include <stdbool.h>

#include "FreeRTOS.h"
#include "task.h"
#include "timers.h"
#include "queue.h"

#include "loglevels.h"
#include "config.h"
#include "ml.h"

#include "rt_nonfinite.h"
#include "sleepstagescorer.h"
#include "sleepstagescorer_terminate.h"

#define ML_EVENT_QUEUE_SIZE 10

static const char *TAG = "ml";	// Logging prefix for this module

//
// Task events:
//
typedef enum
{
  ML_EVENT_ENTER_STATE,	// (used for state transitions)
  ML_EVENT_INPUT
} ml_event_type_t;

// Events are passed to the g_event_queue with an optional
// void *user_data pointer (which may be NULL).
typedef struct
{
  ml_event_type_t type;
  void *user_data;
} ml_event_t;


//
// State machine states:
//
typedef enum
{
  ML_STATE_STANDBY,
  ML_STATE_INFERENCE
} ml_state_t;

//
// Global context data:
//
typedef struct
{
  ml_state_t state;
  // TODO: Other "global" vars shared between events or states goes here.
} ml_context_t;

static ml_context_t g_context;

// Global event queue and handler:
static uint8_t g_event_queue_array[ML_EVENT_QUEUE_SIZE*sizeof(ml_event_t)];
static StaticQueue_t g_event_queue_struct;
static QueueHandle_t g_event_queue;
static void handle_event(ml_event_t *event);
float output[5];
float input[1250] = {
        -0.015998831F,    -0.00995210186F,  -0.0025019031F,   0.00114338892F,
        -0.00020898784F,  -0.00384809589F,  -0.00642136484F,  -0.00693348469F,
        -0.00725885062F,  -0.00970798358F,  -0.0137507617F,   -0.0158526562F,
        -0.0133553213F,   -0.00776061229F,  -0.00301943347F,  -0.00104961183F,
        -0.000348620088F, 0.000914415286F,  0.00206969888F,   0.00141151866F,
        -0.000393433758F, -0.000416804338F, 0.00244042021F,   0.00523846364F,
        0.00467613712F,   0.00229713088F,   0.00343917357F,   0.00987403188F,
        0.0159030408F,    0.0147507396F,    0.00791899581F,   0.00436035F,
        0.0093035223F,    0.0175672509F,    0.0207798835F,    0.0183866713F,
        0.0172080509F,    0.0212535057F,    0.0267905574F,    0.0283767674F,
        0.0257955268F,    0.0228260029F,    0.0215317439F,    0.0203093123F,
        0.0170815568F,    0.0128438137F,    0.0114378044F,    0.0155556789F,
        0.0228545051F,    0.0271606818F,    0.0250046533F,    0.0200964548F,
        0.0189244486F,    0.0221611932F,    0.0236139726F,    0.0188138913F,
        0.0115400897F,    0.00910795294F,   0.0130654546F,    0.0181209445F,
        0.0200236645F,    0.0206584651F,    0.0236379523F,    0.0279320851F,
        0.0291427206F,    0.025854174F,     0.0213223491F,    0.0185352657F,
        0.0164503064F,    0.01291072F,      0.00970379636F,   0.0117649632F,
        0.0205855481F,    0.0305688102F,    0.0339306854F,    0.0288099404F,
        0.0212236121F,    0.0187523887F,    0.0227917675F,    0.0273924712F,
        0.0258954763F,    0.0185915306F,    0.0129743041F,    0.0155756325F,
        0.0243789405F,    0.0310458578F,    0.0303220265F,    0.0248848181F,
        0.0203722529F,    0.0184200648F,    0.0169097073F,    0.0154254204F,
        0.0168716293F,    0.0228273235F,    0.0298327282F,    0.0322006494F,
        0.0275799651F,    0.0186080076F,    0.00999538507F,   0.00501933414F,
        0.00397318555F,   0.00480376F,      0.00556700444F,   0.00686865812F,
        0.0111166351F,    0.0183369648F,    0.0236013867F,    0.0209099986F,
        0.0105924532F,    0.00117056014F,   0.00161845179F,   0.0116449641F,
        0.0213472489F,    0.0213548187F,    0.0122946F,       0.00324114366F,
        0.00168753264F,   0.00662135426F,   0.0113805765F,    0.0113226734F,
        0.0071989214F,    0.00215622899F,   -0.00173883734F,  -0.00317717809F,
        -0.000768064812F, 0.00453428552F,   0.00775031187F,   0.00451981882F,
        -0.00244256F,     -0.00511365291F,  0.000196975088F,  0.00756076118F,
        0.00797664467F,   -8.0155929E-5F,   -0.00905202795F,  -0.0112282168F,
        -0.00709487684F,  -0.00347913499F,  -0.00469790818F,  -0.00790826F,
        -0.00776176294F,  -0.00362753309F,  -9.58923411E-5F,  -0.000845075527F,
        -0.00432539452F,  -0.00641173404F,  -0.00591561431F,  -0.00599279394F,
        -0.010187706F,    -0.0179631822F,   -0.0244423691F,   -0.0244617146F,
        -0.0173201393F,   -0.00800956786F,  -0.00306064333F,  -0.00425964268F,
        -0.00705871079F,  -0.00619120104F,  -0.00222047651F,  -0.00111686159F,
        -0.00713328924F,  -0.0171330534F,   -0.0229419544F,   -0.0193319488F,
        -0.00897546F,     0.000744540244F,  0.00489792321F,   0.004287872F,
        0.00271399249F,   0.00251310552F,   0.00268110866F,   0.000483325712F,
        -0.00511794211F,  -0.0113433339F,   -0.0132920723F,   -0.00838827807F,
        0.000711187895F,  0.00791850872F,   0.00881048199F,   0.00433394359F,
        -0.000332195719F, -0.000750510488F, 0.00262718275F,   0.00521617F,
        0.00330131711F,   -0.001977887F,    -0.00605145842F,  -0.00591521058F,
        -0.00291182287F,  -0.000737582857F, -0.00160525192F,  -0.00450686598F,
        -0.00651767245F,  -0.00554254F,     -0.00229332224F,  0.000299082603F,
        8.70793301E-5F,   -0.00199633138F,  -0.00331637636F,  -0.00304604694F,
        -0.00312080025F,  -0.00511893909F,  -0.0072839139F,   -0.00621152855F,
        -0.00160298F,     0.00216485071F,   0.000571263488F,  -0.00531898439F,
        -0.00926242396F,  -0.00675532361F,  -0.000436946633F, 0.00297615421F,
        0.000827025389F,  -0.00242662872F,  -0.00123388739F,  0.00362791191F,
        0.00598342298F,   0.00247048889F,   -0.00286693592F,  -0.00369941466F,
        0.00072047452F,   0.00507387752F,   0.00467861071F,   0.000306425238F,
        -0.00408200547F,  -0.00644463953F,  -0.00825578161F,  -0.011658282F,
        -0.0161099955F,   -0.0186139848F,   -0.0174433645F,   -0.014697942F,
        -0.0140500572F,   -0.0162308812F,   -0.018193692F,    -0.0174685083F,
        -0.0160138197F,   -0.0177964624F,   -0.0229642093F,   -0.0269460324F,
        -0.0261325147F,   -0.0223973393F,   -0.0204321314F,   -0.0216648709F,
        -0.0226924F,      -0.0200997721F,   -0.0154141039F,   -0.0136358934F,
        -0.0169445425F,   -0.0216485225F,   -0.022520123F,    -0.0191192534F,
        -0.0160025954F,   -0.0165821258F,   -0.0188183431F,   -0.0185341612F,
        -0.0155857131F,   -0.0140057113F,   -0.0158427134F,   -0.0177410599F,
        -0.0156693291F,   -0.0113213807F,   -0.0106323892F,   -0.0157512762F,
        -0.0213825125F,   -0.0207269136F,   -0.0136139477F,   -0.00704492629F,
        -0.0077330838F,   -0.0150136938F,   -0.0216588024F,   -0.021301968F,
        -0.0142617309F,   -0.00628767908F,  -0.00299665146F,  -0.00596603286F,
        -0.0125312041F,   -0.0178633239F,   -0.0182044059F,   -0.0137238204F,
        -0.00817360729F,  -0.00515855709F,  -0.0050988975F,   -0.00590738235F,
        -0.00559530733F,  -0.00375069119F,  -0.00144872232F,  -0.00043719745F,
        -0.00178757973F,  -0.00457325578F,  -0.00609586528F,  -0.00425951555F,
        3.86577585E-6F,   0.00337256608F,   0.00365043804F,   0.0020014972F,
        0.00128021953F,   0.00303313159F,   0.00674621155F,   0.0110372361F,
        0.0145039596F,    0.0159503575F,    0.0151004726F,    0.0133681418F,
        0.0130904093F,    0.0153028872F,    0.0184334181F,    0.0198122058F,
        0.0186298732F,    0.0168236066F,    0.0166607853F,    0.0180781633F,
        0.019270651F,     0.0195013937F,    0.0199655406F,    0.0216896869F,
        0.0238670781F,    0.0249738563F,    0.0248763673F,    0.0250123832F,
        0.0263769273F,    0.0278537832F,    0.0271010958F,    0.023178976F,
        0.017916441F,     0.0143140433F,    0.0137303807F,    0.0149381822F,
        0.0157344956F,    0.0151100773F,    0.0139379725F,    0.0136930896F,
        0.0145059656F,    0.014869852F,     0.0135740796F,    0.0112625007F,
        0.0093452232F,    0.00798630062F,   0.00622303691F,   0.00389092F,
        0.00249280571F,   0.00368237565F,   0.00683307694F,   0.00841089804F,
        0.00478953915F,   -0.00353488442F,  -0.0112643801F,   -0.0130956769F,
        -0.00929420721F,  -0.00547768269F,  -0.00628689071F,  -0.0101704551F,
        -0.0116602341F,   -0.0084350938F,   -0.00438989326F,  -0.00486213341F,
        -0.0100917509F,   -0.0150763635F,   -0.0155737512F,   -0.0125359101F,
        -0.0102350414F,   -0.011393751F,    -0.0149435699F,   -0.0177507196F,
        -0.0177751277F,   -0.0157452039F,   -0.0139728254F,   -0.0136476792F,
        -0.0138985245F,   -0.0137451747F,   -0.0137660922F,   -0.0147110131F,
        -0.0155434087F,   -0.0146684349F,   -0.0126862666F,   -0.0119473459F,
        -0.0130165666F,   -0.0133493049F,   -0.0106603205F,   -0.00656456687F,
        -0.00499442499F,  -0.00670984061F,  -0.00736188749F,  -0.00298765535F,
        0.00350683811F,   0.00443925662F,   -0.00294042961F,  -0.0114764879F,
        -0.0116208568F,   -0.00269793416F,  0.00646088086F,   0.00800895784F,
        0.00327697606F,   -0.000331646152F, 0.0018054765F,    0.00758892437F,
        0.0118362727F,    0.0117677795F,    0.00888466462F,   0.00688272F,
        0.00819390547F,   0.0118297F,       0.0142433075F,    0.0127780419F,
        0.0085652126F,    0.00556124561F,   0.00633600913F,   0.00922618527F,
        0.010152977F,     0.00710948883F,   0.00248267665F,   0.000797193905F,
        0.00412325794F,   0.00974160805F,   0.0126808314F,    0.0109342514F,
        0.00783168711F,   0.00839358382F,   0.0132572865F,    0.0173991434F,
        0.0158280451F,    0.00966719072F,   0.00482130563F,   0.00456287339F,
        0.00556718232F,   0.00282224035F,   -0.00308709755F,  -0.00644324627F,
        -0.00403346447F,  0.000709290558F,  0.00241109682F,   0.000233043189F,
        -0.00236635841F,  -0.00292029628F,  -0.00248007F,     -0.00297779404F,
        -0.00433297688F,  -0.00523010315F,  -0.00554858334F,  -0.0067171976F,
        -0.00980849378F,  -0.0138831893F,   -0.0164758246F,   -0.0160766672F,
        -0.0141689694F,   -0.0140687926F,   -0.0173422955F,   -0.0219672956F,
        -0.024480626F,    -0.0235275663F,   -0.0209089871F,   -0.0194927733F,
        -0.0205814559F,   -0.0231712237F,   -0.0251427423F,   -0.02489141F,
        -0.0224554557F,   -0.0197775941F,   -0.0193891115F,   -0.0217552092F,
        -0.0240650699F,   -0.0230251849F,   -0.0191968586F,   -0.0170009956F,
        -0.0193713866F,   -0.0236355215F,   -0.0243072119F,   -0.0196545757F,
        -0.0139518641F,   -0.0124583319F,   -0.0149846775F,   -0.0159513354F,
        -0.011249044F,    -0.00358939776F,  0.000478663802F,  -0.0017822833F,
        -0.00656567328F,  -0.00864860229F,  -0.0073203817F,   -0.00594089366F,
        -0.0068037957F,   -0.00836119149F,  -0.00770731224F,  -0.00440712227F,
        -0.000802904658F, 0.00108404388F,   0.00165613089F,   0.00224634819F,
        0.00282802619F,   0.00263234042F,   0.00218866835F,   0.00268238899F,
        0.00331832212F,   0.00160905602F,   -0.00267518545F,  -0.00570241269F,
        -0.00365879107F,  0.00208328012F,   0.00576780457F,   0.00336064328F,
        -0.00341021223F,  -0.00930411741F,  -0.0106821107F,   -0.00792341121F,
        -0.00376057718F,  -0.000217197623F, 0.0027222028F,    0.00583406352F,
        0.00887151156F,   0.0109828366F,    0.0126220342F,    0.0153704491F,
        0.0189157259F,    0.019556962F,     0.0138647277F,    0.00390568795F,
        -0.00334085431F,  -0.00301954476F,  0.00252518826F,   0.00712251524F,
        0.0079681715F,    0.0074442178F,    0.0084759919F,    0.0106175477F,
        0.011521386F,     0.0106960405F,    0.0101842172F,    0.0114257718F,
        0.0127405049F,    0.0113844769F,    0.0080004409F,    0.00693204068F,
        0.0105966227F,    0.0151580777F,    0.0146966837F,    0.00950833317F,
        0.00684313755F,   0.0118155517F,    0.0203965753F,    0.0241684988F,
        0.0203642864F,    0.0140130846F,    0.0106190983F,    0.0101024667F,
        0.00922345649F,   0.00740037533F,   0.0073036328F,    0.0102384342F,
        0.0137520488F,    0.0150028272F,    0.0147801191F,    0.0162331313F,
        0.0200577565F,    0.0228745118F,    0.0210847948F,    0.0153630879F,
        0.0105003137F,    0.0108960597F,    0.0163841601F,    0.0224863738F,
        0.0249381326F,    0.0238516014F,    0.0226776935F,    0.0231675766F,
        0.0230890699F,    0.020096831F,     0.0167138465F,    0.0191296935F,
        0.0297230911F,    0.0419931F,       0.0457590856F,    0.0383954048F,
        0.0285676904F,    0.0266277697F,    0.0326377116F,    0.0365249179F,
        0.0299620815F,    0.0158393215F,    0.00508151343F,   0.00529050268F,
        0.0135965301F,    0.0204336699F,    0.0194419194F,    0.0129196774F,
        0.00769372564F,   0.00717063155F,   0.009130436F,     0.0106810927F,
        0.0124061247F,    0.015930526F,     0.0193704069F,    0.0183063745F,
        0.0117206257F,    0.00474455114F,   0.00372525095F,   0.00913036335F,
        0.0148950145F,    0.0149891125F,    0.00931982696F,   0.00235520932F,
        -0.00271823164F,  -0.00617991341F,  -0.00822581258F,  -0.00641938113F,
        0.000723301491F,  0.00905153F,      0.01133502F,      0.00558657059F,
        -0.00148106227F,  -0.00120217679F,  0.0075307251F,    0.0167509262F,
        0.017236894F,     0.00690430356F,   -0.00860452652F,  -0.0221871566F,
        -0.0307536237F,   -0.0353399254F,   -0.0382861942F,   -0.0414101519F,
        -0.0456490889F,   -0.0507026091F,   -0.054123193F,    -0.0507456F,
        -0.0347149372F,   -0.00534879277F,  0.0275893416F,    0.0473649129F,
        0.0433278866F,    0.0214715935F,    -0.000352882664F, -0.00905289F,
        -0.00701792492F,  -0.00626487192F,  -0.0147114638F,   -0.0303724501F,
        -0.0471664257F,   -0.0620289072F,   -0.0740862265F,   -0.079355F,
        -0.0713284537F,   -0.0493955351F,   -0.0241243131F,   -0.00947503932F,
        -0.00846918114F,  -0.00966981333F,  -0.00034342517F,  0.0184225943F,
        0.0323609598F,    0.0294156931F,    0.011765942F,     -0.00839732774F,
        -0.0220515747F,   -0.0290570445F,   -0.0322300903F,   -0.0306852758F,
        -0.0213251654F,   -0.00413856F,     0.017164832F,     0.038650468F,
        0.0568365641F,    0.0659083426F,    0.0588829257F,    0.0353229754F,
        0.00624597399F,   -0.0131287146F,   -0.0171568133F,   -0.0143549601F,
        -0.0169096552F,   -0.0269446149F,   -0.034864258F,    -0.0309474021F,
        -0.0163396373F,   -0.000728824583F, 0.00961921085F,   0.0178349633F,
        0.0290694237F,    0.0405404493F,    0.0433411226F,    0.0341891386F,
        0.0213501807F,    0.0161885452F,    0.020352615F,     0.0241091903F,
        0.017398743F,     0.000272121135F,  -0.0182866212F,   -0.0295197386F,
        -0.0310388617F,   -0.0256564319F,   -0.0171422567F,   -0.00753442F,
        0.00313140755F,   0.0155120417F,    0.0290129445F,    0.0405326746F,
        0.0453257449F,    0.0401781909F,    0.0266503282F,    0.0109808501F,
        -0.000132301851F, -0.00426724134F,  -0.00403259182F,  -0.00340612978F,
        -0.0037794821F,   -0.00391632691F,  -0.00340629159F,  -0.00472946325F,
        -0.0104394518F,   -0.0185828097F,   -0.0228533689F,   -0.0184553042F,
        -0.00703405961F,  0.00482019875F,   0.0109244278F,    0.00882668793F,
        -0.000366589898F, -0.0133047756F,   -0.025617864F,    -0.0335462205F,
        -0.0356153212F,   -0.0329997167F,   -0.0283564143F,   -0.0242289025F,
        -0.0218243264F,   -0.0206780136F,   -0.0198189337F,   -0.0195266176F,
        -0.0211560242F,   -0.0247041341F,   -0.0274333842F,   -0.0258725435F,
        -0.0190088246F,   -0.00925946049F,  -0.000855129F,    0.00266196718F,
        0.000612705771F,  -0.00417963F,     -0.00751444604F,  -0.00753411744F,
        -0.00642926153F,  -0.00792467594F,  -0.0127183199F,   -0.0169086829F,
        -0.0159192942F,   -0.00982444175F,  -0.00335184322F,  -0.000108315471F,
        0.00171695172F,   0.00650630612F,   0.0147196725F,    0.0210006833F,
        0.0195541102F,    0.0106297685F,    0.000596337079F,  -0.00422760379F,
        -0.00266906107F,  0.0023612238F,    0.00796039F,      0.0124282986F,
        0.0136389695F,    0.00949529652F,   0.00108392339F,   -0.00669283886F,
        -0.00941588636F,  -0.00761827221F,  -0.00596980425F,  -0.00792353693F,
        -0.0116225192F,   -0.0117420498F,   -0.00587978913F,  0.00145722379F,
        0.00263478071F,   -0.00493827229F,  -0.0155420564F,   -0.0209957082F,
        -0.0191719439F,   -0.0153519558F,   -0.0151427826F,   -0.0179447588F,
        -0.0187345315F,   -0.0150302546F,   -0.0100231199F,   -0.00870583486F,
        -0.0123967873F,   -0.0177964419F,   -0.0206671525F,   -0.0197016615F,
        -0.0170222763F,   -0.0154108917F,   -0.0153787341F,   -0.015316193F,
        -0.0143800173F,   -0.0140573867F,   -0.0160591584F,   -0.0194856506F,
        -0.0212147254F,   -0.0189747605F,   -0.0135117956F,   -0.00797996484F,
        -0.0055711153F,   -0.00731728412F,  -0.0116735836F,   -0.0163988974F,
        -0.020958934F,    -0.0264594816F,   -0.0328626521F,   -0.0372610465F,
        -0.0362834185F,   -0.030256154F,    -0.0237942971F,   -0.0215552114F,
        -0.0238683708F,   -0.0270162281F,   -0.0273728799F,   -0.0247690212F,
        -0.0221142F,      -0.0222090036F,   -0.0248003565F,   -0.0265575349F,
        -0.0244104564F,   -0.0193354059F,   -0.0159860384F,   -0.0174071696F,
        -0.0208127145F,   -0.020557167F,    -0.0154542988F,   -0.0109833023F,
        -0.0129167913F,   -0.0202644318F,   -0.0263756588F,   -0.0263101608F,
        -0.0211278815F,   -0.0149729783F,   -0.0101901432F,   -0.00650343532F,
        -0.0033990005F,   -0.00121171167F,  -0.000125166334F, 0.00011048439F,
        -0.000715306203F, -0.00281379302F,  -0.00460122759F,  -0.00321317534F,
        0.00174372026F,   0.00621000351F,   0.00565464841F,   0.000978979748F,
        -0.00173217675F,  0.00160336576F,   0.00785258878F,   0.0105475057F,
        0.00796930119F,   0.00476640277F,   0.00536781084F,   0.00867531542F,
        0.0109715415F,    0.01178429F,      0.0137883481F,    0.0174860395F,
        0.0191880465F,    0.0155900251F,    0.00878167897F,   0.00500345416F,
        0.00828110613F,   0.0160311963F,    0.0213349815F,    0.0192052741F,
        0.0105947871F,    0.0011707329F,    -0.00326537178F,  -0.00111365935F,
        0.00389891F,      0.00596703496F,   0.00267596543F,   -0.00246626767F,
        -0.0037540542F,   0.00020132144F,   0.00475643482F,   0.00486475788F,
        0.00138106267F,   0.000140804303F,  0.00491302786F,   0.0128726335F,
        0.0179809127F,    0.0178474318F,    0.0154873F,       0.014438564F,
        0.0144322356F,    0.0130426418F,    0.00983037427F,   0.00682302937F,
        0.0055783526F,    0.00594593398F,   0.00795378815F,   0.0126387617F,
        0.0194207039F,    0.0240120366F,    0.0214305557F,    0.0118164876F,
        0.0017924672F,    -0.00158679637F,  0.00202076859F,   0.00662385672F,
        0.007250831F,     0.00493090739F,   0.00388011988F,   0.00586037664F,
        0.00914401095F,   0.0122016249F,    0.0157870259F,    0.0202046186F,
        0.0222967099F,    0.0178982764F,    0.00813233107F,   0.000633906166F,
        0.00113525009F,   0.00531890336F,   0.00406611F,      -0.00349597982F,
        -0.0089264838F,   -0.00847281609F,  -0.0103067905F,   -0.0220341608F,
        -0.0373038165F,   -0.0429123379F,   -0.036417447F,    -0.0298294798F,
        -0.0358139165F,   -0.0535711385F,   -0.0691839606F,   -0.0698869F,
        -0.0576936714F,   -0.047091607F,    -0.0490911826F,   -0.0608342551F,
        -0.0719944164F,   -0.0772437081F,   -0.0793923959F,   -0.0822832808F,
        -0.0841878876F,   -0.0800882876F,   -0.0697769225F,   -0.0609165169F,
        -0.061712347F,    -0.0715591088F,   -0.08183828F,     -0.0857517421F,
        -0.0842123553F,   -0.081436038F,    -0.078584F,       -0.07496766F,
        -0.072952792F,    -0.0762105733F,   -0.0825195462F,   -0.0835626647F,
        -0.0750531852F,   -0.0638730675F,   -0.0613768511F,   -0.0705728F,
        -0.0828102306F,   -0.0872665867F,   -0.0815490335F,   -0.0723579F,
        -0.0676744655F,   -0.0697447807F,   -0.0744400099F,   -0.075593859F,
        -0.0704164356F,   -0.0620798804F,   -0.0569017F,      -0.0585617F,
        -0.0651144907F,   -0.0707992762F,   -0.0701433F,      -0.0615908764F,
        -0.049095057F,    -0.0399305634F,   -0.0382868722F,   -0.0403168648F,
        -0.0377967618F,   -0.02730974F,     -0.0140684582F,   -0.00606935145F,
        -0.00566944154F,  -0.00789779425F,  -0.00640197378F,  0.000338409358F,
        0.00873440597F,   0.0148966275F,    0.018709667F,     0.0225369688F,
        0.0269646551F,    0.029893823F,     0.029612571F,     0.0270302575F,
        0.0249318238F,    0.0260971021F,    0.031818863F,     0.0408045948F,
        0.0491567589F,    0.0529494211F,    0.0522953793F,    0.052372F,
        0.0585469529F,    0.0696639046F,    0.0776686743F,    0.0757858455F,
        0.0664714202F,    0.0590931922F,    0.0596510209F,    0.0648732483F,
        0.0670452267F,    0.0627547652F,    0.055810187F,     0.0529811159F,
        0.057831414F,     0.0674493909F,    0.0746394396F,    0.0744251683F,
        0.0683103055F,    0.0611820221F,    0.0552051589F,    0.0490095802F,
        0.0422852859F,    0.0377577692F,    0.0374482349F,    0.0400079563F,
        0.0435105525F,    0.0482261144F,    0.054478541F,     0.0595658943F,
        0.0594410859F,    0.0536190718F,    0.0467032082F,    0.0438357443F,
        0.0449625701F,    0.0444774702F,    0.0371133573F,    0.0245451666F,
        0.0153850699F,    0.016883079F,     0.0268219579F,    0.035809394F,
        0.0374892317F,    0.0336297862F,    0.0288301464F,    0.0241655353F,
        0.0185164046F,    0.0133684408F,    0.012477342F,     0.0167592969F,
        0.0219923593F,    0.0226930361F,    0.0173877236F,    0.00976106431F,
        0.00542567857F,   0.00733700395F,   0.0131220948F,    0.0166781098F,
        0.013420823F,     0.00470240787F,   -0.00332925678F,  -0.00570809655F,
        -0.00303997379F,  0.000207230143F,  0.000757361355F,  -0.000687000051F,
        -0.000755669898F, 0.00310841575F,   0.00973615F,      0.0148016298F,
        0.0155027173F,    0.0140725831F,    0.0144164972F,    0.0157701578F,
        0.0129221864F,    0.00356092141F,   -0.00721411221F,  -0.0113990167F,
        -0.00603725901F,  0.00429319777F,   0.0121000782F,    0.0132631641F,
        0.00939202588F,   0.00526462495F,   0.00456526689F,   0.00754613336F,
        0.0116599025F,    0.0138223208F,    0.0124073308F,    0.00801983F,
        0.0030051379F,    -5.83238534E-6F,  0.000400697958F,  0.00404868415F,
        0.00971250795F,   0.0154675459F,    0.0193502437F,    0.0212214459F,
        0.0235867407F,    0.0283598341F,    0.0324493945F,    0.0292746071F,
        0.0165723804F,    0.00107015343F,   -0.00674389F,     -0.00219197618F,
        0.00993597F,      0.0202517249F,    0.0225498658F,    0.0180172026F,
        0.013140738F,     0.0134303011F,    0.0187945794F,    0.0248054117F,
        0.0276356693F,    0.0269606318F,    0.0247043669F,    0.0224491786F,
        0.0205236F,       0.0188910719F,    0.0180820227F,    0.0188622829F,
        0.0213046409F,    0.0247818306F,    0.0287631303F,    0.0329649374F,
        0.0365715F,       0.0378668383F,    0.0353451706F,    0.0295569561F,
        0.0235909671F,    0.0209828224F,    0.022533359F,     0.0253700893F,
        0.0258619655F,    0.0235694144F,    0.0217169374F,    0.023485275F,
        0.0282360539F,    0.0319530591F,    0.0314257741F,    0.0274054538F,
        0.0232989509F,    0.0213722493F,    0.0210262612F,    0.0204446223F,
        0.0187632106F,    0.0163647048F,    0.0140993707F,    0.0127859684F,
        0.0126137277F,    0.0124143939F,    0.0103155896F,    0.00587687176F,
        0.0010860787F,    -0.00153623056F,  -0.00167943828F,  -0.00146149041F,
        -0.00282407599F,  -0.00534269819F,  -0.00704004755F,  -0.00689643202F,
        -0.00585523108F,  -0.00529750483F,  -0.00511591556F,  -0.00397446658F,
        -0.00138575828F,  0.00143251359F,   0.00321628433F,   0.00435534166F,
        0.0061927787F,    0.00899699517F,   0.0112717934F,    0.0112067005F,
        0.0086737657F,    0.00563120143F,   0.00454045972F,   0.00638834434F,
        0.00981065538F,   0.0118348096F,    0.0101872087F,    0.00560020423F,
        0.00131715718F,   -0.000289148709F, 5.59118635E-5F,   0.000258876767F,
        -0.00023981338F,  -0.000431726978F, 0.000230157588F,  0.00120514934F,
        0.00197681435F,   0.00255125714F,   0.00278633786F,   0.00238487404F,
        0.00197993056F,   0.00303338608F,   0.00564859482F,   0.0075306627F,
        0.00674899295F,   0.00483434973F,   0.00512287859F,   0.00827826932F,
        0.0113967732F,    0.011601462F,     0.00902710203F,   0.00608045096F,
        0.0048450334F,    0.0056700781F,    0.00771313068F,   0.010058634F,
        0.0120292958F,    0.0129810851F,    0.012775721F,     0.0126658631F,
        0.0147827184F,    0.0198056661F,    0.0253633335F,    0.0277879816F,
        0.0259793345F,    0.022978317F,     0.0228420831F,    0.0260816887F,
        0.0291319154F,    0.0284551531F,    0.0244110189F,    0.0208720509F,
        0.0214711782F,    0.0262469966F,    0.0315549411F,    0.0333347172F,
        0.0310304724F,    0.0283850878F,    0.0296697672F,    0.0347476713F,
        0.0386401676F,    0.0368177108F,    0.0302280542F,    0.0238740407F,
        0.021164123F,     0.0215947498F,    0.0236949958F,    0.0276409015F,
        0.0337101556F,    0.0398186371F,    0.0426906869F,    0.0414907F,
        0.0387874208F,    0.0372534879F};

// For logging and debug:
static const char * ml_state_name(ml_state_t state)
{
  switch (state) {
    case ML_STATE_STANDBY: return "ML_STATE_STANDBY";
    case ML_STATE_INFERENCE: return "ML_STATE_INFERENCE";
    default:
      break;
  }
  return "ML_STATE UNKNOWN";
}

static const char * ml_event_type_name(ml_event_type_t event_type)
{
  switch (event_type) {
    case ML_EVENT_ENTER_STATE: return "ML_EVENT_ENTER_STATE";
    case ML_EVENT_INPUT: return "ML_EVENT_INPUT";
    default:
      break;
  }
  return "ML_EVENT UNKNOWN";
}

void ml_event_input(void)
{
  ml_event_t event = {.type = ML_EVENT_INPUT, .user_data = NULL };
  xQueueSend(g_event_queue, &event, portMAX_DELAY);
}

//void ml_event_output(int *output) // on output, send output to application or something to eventually log
//{
////  dils_event_t event = {.type = DILS_EVENT_OUTPUT, .user_data = NULL };
////  xQueueSend(g_event_queue, &event, portMAX_DELAY);
//	LOGV(TAG, "Output: %d", output);
//}

static void log_event(ml_event_t *event)
{
  switch (event->type) {
    default:
      LOGV(TAG, "[%s] Event: %s\n\r", ml_state_name(g_context.state), ml_event_type_name(event->type));
      break;
  }
}

static void log_event_ignored(ml_event_t *event)
{
  LOGD(TAG, "[%s] Ignored Event: %s\n\r", ml_state_name(g_context.state), ml_event_type_name(event->type));
}


//
// Event handlers for the various application states:
//
static void set_state(ml_state_t state)
{
//  LOGD(TAG, "[%s] -> [%s]\n\r", ml_state_name(g_context.state), ml_state_name(state));

  g_context.state = state;

  // Immediately process an ENTER_STATE event, before any other pending events.
  // This allows the app to do state-specific init/setup when changing states.
  ml_event_t event = { ML_EVENT_ENTER_STATE, (void *) state };
  handle_event(&event);
}

static void handle_state_standby(ml_event_t *event)
{

  switch (event->type) {
    case ML_EVENT_ENTER_STATE:
      // Generic code to always execute when entering this state goes here.
      break;

    case ML_EVENT_INPUT:
      set_state(ML_STATE_INFERENCE);
      break;

    default:
      log_event_ignored(event);
      break;
  }
}

static void handle_state_inference(ml_event_t *event)
{
  switch (event->type) {
    case ML_EVENT_ENTER_STATE:
      // Generic code to always execute when entering this state goes here.

      // hifi_inference(constantWeight, mutableWeight, activations);
    	LOGV(TAG, "starting inference");
      sleepstagescorer(input, output);
      LOGV(TAG, "Inference output: %f, %f, %f, %f, %f\n\r", output[0], output[1], output[2], output[3], output[4]);
      set_state(ML_STATE_STANDBY);
      break;

    default:
      log_event_ignored(event);
      break;
  }
}

static void handle_event(ml_event_t *event)
{
  switch (g_context.state) {
    case ML_STATE_STANDBY:
      handle_state_standby(event);
      break;

    case ML_STATE_INFERENCE:
      handle_state_inference(event);
      break;

    default:
      // (We should never get here.)
      LOGE(TAG, "Unknown ml state: %d\n\r", (int) g_context.state);
      break;
  }
}

void ml_pretask_init(void)
{
  // Any pre-scheduler init goes here.

  // Create the event queue before the scheduler starts. Avoids race conditions.
  g_event_queue = xQueueCreateStatic(ML_EVENT_QUEUE_SIZE,sizeof(ml_event_t),g_event_queue_array,&g_event_queue_struct);
  vQueueAddToRegistry(g_event_queue, "ml_event_queue");

}


static void task_init()
{
  // Any post-scheduler init goes here.
  set_state(ML_STATE_STANDBY);
  LOGV(TAG, "Task launched. Entering event loop.\n\r");
}

void ml_task(void *ignored)
{
  task_init();

  ml_event_t event;

  while (1) {

    // Get the next event.
    xQueueReceive(g_event_queue, &event, portMAX_DELAY);

    log_event(&event);

    handle_event(&event);
  }
}
